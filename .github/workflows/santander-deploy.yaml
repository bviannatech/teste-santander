name: Santander - Teste

on:
  push:
    branches: main

permissions:
  id-token: write
  contents: read
  actions: read

jobs:

  build:
    environment: dev
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 12.x
        cache: 'npm'

    - name: npm install
      run: |
        npm install

    - name: Checkout repository
      uses: actions/checkout@v2
          
    - name: Login Azure
      uses: azure/docker-login@v1
      with:
        version: v0.7.0
        login-server: ${{ secrets.ACR_REGISTRY_NAME }}.azurecr.io
        username: ${{ secrets.AZURE_ACR_USERNAME }}
        password: ${{ secrets.AZURE_ACR_PASSWORD }}
    - name: Build and Push image to ACR
      run: |
        docker build -t ${{ secrets.ACR_REGISTRY_NAME }}.azurecr.io/santander:${{ github.sha }} .
        docker push ${{ secrets.ACR_REGISTRY_NAME }}.azurecr.io/santander:${{ github.sha }}

    #- name: Send mail
    #  if: always()
    #  uses: dawidd6/action-send-mail@v2
    #  with:
    #    server_address: smtp.gmail.com
    #    server_port: 465
    #    #username: ${{ secrets.EMAIL_USERNAME }}
    #    #password: ${{ secrets.EMAIL_PASSWORD }}
    #    subject: ${{ github.job }} job of ${{ github.repository }} has ${{ job.status }}
    #    body: ${{ github.job }} job in worflow ${{ github.workflow }} of ${{ github.repository }} has ${{ job.status }}
    #    to: bruno.svianna.it@gmail.com
    #    from: Bruno Viana
    #    secure: true
    #    ignore_cert: true
    #    convert_markdown: true
    #    priority: low

  deploy-aks-stage:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Login Azure
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Access Cluster AKS
        id: set-context
        uses: Azure/aks-set-context@v3
        with:          
          resource-group: ${{ secrets.RESOURCE_GROUP }}
          cluster-name: ${{ secrets.CLUSTER_NAME }}
          admin: true
          use-kubelogin: false

      - name: Deploy
        uses: Azure/k8s-deploy@v4
        with:
          namespace: frontend
          actions: deploy
          manifests: |
            manifests/santander-deploy.yaml
          images: |
            ${{ secrets.ACR_REGISTRY_NAME }}.azurecr.io/santander:${{ github.sha }}